{
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json",
  "version": "Notebook/1.0",
  "metadata": {
    "configuration_instructions": [
      "1. Replace YOUR_SUBSCRIPTION_ID with your Azure subscription ID",
      "2. Replace YOUR_RESOURCE_GROUP with your resource group name",
      "3. Replace YOUR_WORKSPACE_NAME with your Log Analytics workspace name",
      "Note: The default time duration is set to 24h - modify the \"ago(24h)\" in queries if you want to change the time window"
    ]
  },
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# üîç AVD Connection Health Analysis\n\nThis workbook monitors Azure Virtual Desktop (AVD) connection health by analyzing the complete connection lifecycle across three key areas:\n\n## 1. üè• User Health Status\n- Monitors user connection success rates\n- Tracks recent failures and connection patterns\n- Provides health scores based on connection reliability\n\n## 2. ‚è±Ô∏è Connection Timing Analysis\n- Analyzes connection duration patterns\n- Identifies potential hanging sessions\n- Tracks connection state transitions\n\n## 3. üìä Host Health Analysis\n- Tracks the full connection lifecycle (Started ‚Üí Connected ‚Üí Completed)\n- Identifies failed connections (sessions that start but never connect)\n- Calculates success rates based on actual connection attempts\n\n**Connection States:**\n- Started: Initial connection attempt\n- Connected: Successfully established connection\n- Completed: Normal session termination\n- Failed: Started but never reached Connected state\n\n**Note:** All analyses focus on the last 24 hours of connection data, filtering out invalid or incomplete records."
      },
      "name": "overview"
    },
    {
      "type": 1,
      "content": {
        "json": "## üîç Connection Status Detail\nShows all connection attempts and their outcomes across session hosts. Authentication issues are highlighted separately from host health issues.\n\n**Alert Considerations:**\n- Multiple host health issues within an hour\n- Consecutive failures on the same host\n- High failure counts for specific error types"
      },
      "name": "connection-failures-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "WVDConnections\n| where TimeGenerated > ago(24h)\n| where isnotempty(SessionHostName) and SessionHostName != \"<>\"\n| extend IssueCategory = case(\n    State == \"Connected\", strcat(\"‚úÖ Connected: \", State),\n    State == \"Started\", strcat(\"üì° In Progress: \", State),\n    State contains \"Rejected\" and ClientType contains \"RDP\", strcat(\"‚ö†Ô∏è Authentication Failed: \", State),\n    State contains \"Rejected by client\", strcat(\"üë§ User Cancelled: \", State),\n    State contains \"Rejected by server\", strcat(\"üîí Server Rejected: \", State),\n    State contains \"NotFound\", strcat(\"‚ùå Host Not Found: \", State),\n    State contains \"ConnectionTimeout\", strcat(\"‚è±Ô∏è Host Timeout: \", State),\n    State contains \"Failed\", strcat(\"üè• Connection Failed: \", State),\n    strcat(\"‚ö° Other State: \", State))\n| extend StatusType = case(\n    IssueCategory startswith \"‚úÖ\", \"SUCCESS\",\n    IssueCategory startswith \"üì°\", \"IN_PROGRESS\",\n    IssueCategory startswith \"üë§\", \"USER_ACTION\",\n    IssueCategory startswith \"‚ö†Ô∏è\" or IssueCategory startswith \"üîí\", \"AUTH_ISSUE\",\n    IssueCategory startswith \"‚ùå\" or IssueCategory startswith \"‚è±Ô∏è\" or IssueCategory startswith \"üè•\", \"HOST_ISSUE\",\n    \"OTHER\")\n| extend ClientType = ClientType\n| extend UserName = UserName\n| summarize AttemptCount = count(), \n            AffectedUsers = make_set(UserName, 5),\n            LastSeen = max(TimeGenerated),\n            FirstSeen = min(TimeGenerated)\n            by SessionHostName, \n               IssueCategory,\n               StatusType,\n               ClientType\n| extend Duration = LastSeen - FirstSeen\n| project \n    SessionHostName, \n    IssueCategory,\n    StatusType,\n    ClientType,\n    AttemptCount,\n    AffectedUsers,\n    FirstSeen,\n    LastSeen,\n    Duration\n| sort by StatusType asc, AttemptCount desc, LastSeen desc",
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/YOUR_RESOURCE_GROUP/providers/Microsoft.OperationalInsights/workspaces/YOUR_WORKSPACE_NAME"
        ],
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "AttemptCount",
              "formatter": 3,
              "formatOptions": {
                "min": 0,
                "max": null,
                "palette": "custom",
                "customColumnWidthSetting": "100px",
                "customColorRules": [
                  {
                    "operation": "Equal",
                    "valueParam": "SUCCESS",
                    "linkTarget": "CellDetails",
                    "color": "#4BB543"
                  },
                  {
                    "operation": "Equal",
                    "valueParam": "IN_PROGRESS",
                    "linkTarget": "CellDetails",
                    "color": "#0078D4"
                  },
                  {
                    "operation": "Equal",
                    "valueParam": "USER_ACTION",
                    "linkTarget": "CellDetails",
                    "color": "#FFA500"
                  },
                  {
                    "operation": "Equal",
                    "valueParam": "AUTH_ISSUE",
                    "linkTarget": "CellDetails",
                    "color": "#FF8C00"
                  },
                  {
                    "operation": "Default",
                    "linkTarget": "CellDetails",
                    "color": "#E81123"
                  }
                ]
              }
            },
            {
              "columnMatch": "Duration",
              "formatter": 8,
              "formatOptions": {
                "palette": "orange"
              }
            }
          ],
          "filter": true,
          "labelSettings": [
            {
              "columnId": "SessionHostName",
              "label": "Host Name"
            },
            {
              "columnId": "IssueCategory",
              "label": "Connection Status"
            },
            {
              "columnId": "StatusType",
              "label": "Type"
            },
            {
              "columnId": "ClientType",
              "label": "Client Type"
            },
            {
              "columnId": "AttemptCount",
              "label": "Count"
            },
            {
              "columnId": "AffectedUsers",
              "label": "Users"
            },
            {
              "columnId": "FirstSeen",
              "label": "First Seen"
            },
            {
              "columnId": "LastSeen",
              "label": "Last Seen"
            },
            {
              "columnId": "Duration",
              "label": "Duration"
            }
          ]
        }
      },
      "name": "connection-status-detail"
    },
    {
      "type": 1,
      "content": {
        "json": "## üìä Host Health Analysis\nAnalyzes the complete connection lifecycle for each host to identify connection reliability issues and potential problems.\n\n**Connection Lifecycle:**\n- Started ‚Üí Connected ‚Üí Completed (Success)\n- Started ‚Üí Never Connected (Failure)\n\n**Success Rate Calculation:**\n- Success Rate = (Connected Sessions / Started Sessions) √ó 100\n- Failed Connections = Started Sessions - Connected Sessions\n\n**Health Status Thresholds:**\n- üü¢ Excellent: ‚â•90% success rate\n- üü° Good: 70-89% success rate\n- üü† Needs Attention: 50-69% success rate\n- üî¥ Critical: <50% success rate\n\n**Alert Considerations:**\n- Success rates below 70%\n- High number of failed connections\n- Recent failures within the last hour"
      },
      "name": "host-health-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Connection State Distribution\nWVDConnections\n| where TimeGenerated > ago(24h)\n| where isnotempty(SessionHostName) and SessionHostName != \"<>\"\n| extend HostName = tostring(split(SessionHostName, '.')[0])\n| summarize StateCount = count() by State, HostName\n| order by HostName asc, StateCount desc",
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/YOUR_RESOURCE_GROUP/providers/Microsoft.OperationalInsights/workspaces/YOUR_WORKSPACE_NAME"
        ],
        "visualization": "table"
      },
      "name": "connection-state-distribution"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// All Possible Connection States\nWVDConnections\n| where TimeGenerated > ago(24h)\n| where isnotempty(SessionHostName) and SessionHostName != \"<>\"\n| summarize Count=count() by State\n| order by Count desc",
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/YOUR_RESOURCE_GROUP/providers/Microsoft.OperationalInsights/workspaces/YOUR_WORKSPACE_NAME"
        ],
        "visualization": "table"
      },
      "name": "connection-states-analysis"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Host Health Analysis\nWVDConnections\n| where TimeGenerated > ago(24h)\n| where isnotempty(SessionHostName) and SessionHostName != \"<>\"\n| extend HostName = tostring(split(SessionHostName, '.')[0])\n| summarize\n    ConnectionAttempts = countif(State == \"Started\"),\n    SuccessfulConnections = countif(State == \"Connected\"),\n    CompletedSessions = countif(State == \"Completed\"),\n    LastHourAttempts = countif(TimeGenerated > ago(1h) and State == \"Started\"),\n    LastHourConnected = countif(TimeGenerated > ago(1h) and State == \"Connected\")\n    by HostName\n| extend \n    FailedConnections = ConnectionAttempts - SuccessfulConnections,  // Sessions that started but never connected\n    RecentFailures = LastHourAttempts - LastHourConnected,  // Recent sessions that started but never connected\n    SuccessRate = round((toreal(SuccessfulConnections) / toreal(ConnectionAttempts)) * 100, 2)\n| extend HealthStatus = iff(SuccessRate >= 90, \"üü¢ Excellent\",\n    iff(SuccessRate >= 70, \"üü° Good\",\n    iff(SuccessRate >= 50, \"üü† Needs Attention\",\n    \"üî¥ Critical\")))\n| project\n    ['Host Name'] = HostName,\n    ['Health Status'] = HealthStatus,\n    ['Success Rate'] = SuccessRate,\n    ['Connection Attempts'] = ConnectionAttempts,\n    ['Successful'] = SuccessfulConnections,\n    ['Completed'] = CompletedSessions,\n    ['Failed'] = FailedConnections,\n    ['Recent Failures'] = RecentFailures\n| order by ['Success Rate'] desc",
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/YOUR_RESOURCE_GROUP/providers/Microsoft.OperationalInsights/workspaces/YOUR_WORKSPACE_NAME"
        ],
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Success Rate",
              "formatter": 8,
              "formatOptions": {
                "palette": "redGreen",
                "customColumnWidthSetting": "20ch"
              }
            },
            {
              "columnMatch": "ConnectionAttempts",
              "formatter": 4,
              "formatOptions": {
                "palette": "blue",
                "customColumnWidthSetting": "15ch"
              }
            },
            {
              "columnMatch": "FailedConnections",
              "formatter": 4,
              "formatOptions": {
                "palette": "red",
                "customColumnWidthSetting": "15ch"
              }
            }
          ],
          "filter": true,
          "labelSettings": [
            {
              "columnId": "HostPool",
              "label": "Host Pool"
            },
            {
              "columnId": "HealthStatus",
              "label": "Health Status (%)"
            },
            {
              "columnId": "HealthStatus",
              "label": "Status"
            },
            {
              "columnId": "TotalSessions",
              "label": "Total Sessions"
            },
            {
              "columnId": "FailedSessions",
              "label": "Failed Sessions"
            },
            {
              "columnId": "LastFailure",
              "label": "Last Failure Time"
            }
          ]
        }
      },
      "name": "host-failure-rates"
    },
    {
      "type": 1,
      "content": {
        "json": "## üìà Successful Connection Trend\nShows the pattern of successful connections over time. Use this to understand usage patterns and identify unusual drops in successful connections.\n\n**Alert Considerations:**\n- Sudden drops in successful connections\n- Extended periods with no successful connections\n- Unusual spikes or dips compared to historical patterns"
      },
      "name": "connection-trend-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "WVDConnections\n| where TimeGenerated > ago(24h)\n| where isnotempty(SessionHostName) and SessionHostName != \"<>\"\n| where State == \"Connected\"\n| summarize ConnectionCount = count() by bin(TimeGenerated, 1h)\n| render timechart",
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/YOUR_RESOURCE_GROUP/providers/Microsoft.OperationalInsights/workspaces/YOUR_WORKSPACE_NAME"
        ],
        "visualization": "timechart",
        "chartSettings": {
          "seriesLabelSettings": [
            {
              "seriesName": "ConnectionCount",
              "label": "Successful Connections",
              "color": "green"
            }
          ],
          "ySettings": {
            "numberFormatSettings": {
              "unit": 0,
              "options": {
                "style": "decimal",
                "useGrouping": true
              }
            }
          }
        }
      },
      "name": "connection-trend"
    },
    {
      "type": 1,
      "content": {
        "json": "## ‚è±Ô∏è Connection Timing Analysis\nAnalyzes connection timing patterns and potential hanging sessions. This helps identify slow connections, hanging sessions, and unusual connection patterns.\n\n**Thresholds:**\n- Warning: > 30 seconds\n- Critical: > 60 seconds\n- Severe: > 120 seconds\n\n**Connection States:**\n- Started ‚Üí InProgress: Initial connection attempt\n- InProgress ‚Üí Connected: Authentication and session setup\n- Total Connection Time: Full connection lifecycle"
      },
      "name": "connection-timing-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Connection Timing Analysis\nWVDConnections\n| where TimeGenerated > ago(24h)\n| where isnotempty(SessionHostName) and SessionHostName != \"<>\"\n| extend HostName = tostring(split(SessionHostName, '.')[0])\n| serialize\n| extend NextTime = next(TimeGenerated, 1)\n| extend NextState = next(State, 1)\n| extend TimeDiff = coalesce(NextTime - TimeGenerated, timespan(0))\n| where TimeDiff > timespan(0)\n| extend ConnectionStatus = iff(TimeDiff > timespan(120s), \"üî¥ Severe\",\n    iff(TimeDiff > timespan(60s), \"üü† Critical\",\n    iff(TimeDiff > timespan(30s), \"üü° Warning\",\n    \"üü¢ Normal\")))\n| project\n    TimeGenerated,\n    UserName,\n    ['Host Name'] = HostName,\n    ClientType,\n    State,\n    NextState,\n    ['Time Difference'] = TimeDiff,\n    ['Status'] = ConnectionStatus\n| order by TimeGenerated desc",
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/YOUR_RESOURCE_GROUP/providers/Microsoft.OperationalInsights/workspaces/YOUR_WORKSPACE_NAME"
        ],
        "visualization": "table"
      },
      "name": "connection-timing"
    },
    {
      "type": 1,
      "content": {
        "json": "## üë• User Health Status\nProvides a comprehensive health score for each user based on connection success rates and recent failures, excluding authentication-related issues.\n\n**Score Interpretation:**\n- 90-100: Excellent health\n- 70-89: Good health\n- 50-69: Needs attention\n- Below 50: Critical issues\n\n**Alert Considerations:**\n- Health scores below 70%\n- Recent failures within the last hour\n- High failed session counts (excluding auth failures)"
      },
      "name": "user-health-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// User Health Status\nWVDConnections\n| where TimeGenerated > ago(24h)\n| where isnotempty(CorrelationId)\n| summarize\n    TotalAttempts = count(),\n    SuccessfulConnections = countif(State == \"Connected\"),\n    FailedConnections = countif(State contains \"Failed\" or State contains \"Timeout\"),\n    RecentFailures = countif(TimeGenerated > ago(1h) and (State contains \"Failed\" or State contains \"Timeout\"))\n    by UserName\n| extend SuccessRate = round((toreal(SuccessfulConnections) / toreal(TotalAttempts)) * 100, 2)\n| extend HealthStatus = iff(SuccessRate >= 90, \"üü¢ Excellent\",\n    iff(SuccessRate >= 70, \"üü° Good\",\n    iff(SuccessRate >= 50, \"üü† Needs Attention\",\n    \"üî¥ Critical\")))\n| project\n    ['User Name'] = UserName,\n    ['Health Status'] = HealthStatus,\n    ['Success Rate'] = SuccessRate,\n    ['Total Attempts'] = TotalAttempts,\n    ['Successful'] = SuccessfulConnections,\n    ['Failed'] = FailedConnections,\n    ['Recent Failures'] = RecentFailures\n| order by ['Success Rate'] desc",
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/YOUR_RESOURCE_GROUP/providers/Microsoft.OperationalInsights/workspaces/YOUR_WORKSPACE_NAME"
        ],
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Success Rate",
              "formatter": 8,
              "formatOptions": {
                "min": 70,
                "max": 100,
                "palette": "redGreen"
              }
            }
          ]
        }
      },
      "name": "user-health-status"
    },
    {
      "type": 1,
      "content": {
        "json": "## üë• End-User Experience Analysis\nAnalyzes connection patterns and success rates for each user to identify potential issues affecting user experience.\n\n**Score Interpretation:**\n- 90-100: Excellent experience\n- 70-89: Good experience\n- 50-69: Needs attention\n- Below 50: Critical issues\n\n**Alert Considerations:**\n- Success rates below 70%\n- Recent failures within the last hour\n- High number of failed connections"
      },
      "name": "end-user-experience-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// End-User Experience - Connection Status\nWVDConnections\n| where TimeGenerated > ago(24h)\n| where isnotempty(CorrelationId)\n| extend ConnectionStatus = iff(State == \"Connected\", \"üü¢ Success\",\n    iff(State contains \"Failed\" or State contains \"Timeout\", \"üî¥ Failed\",\n    \"üü° Other\"))\n| project\n    TimeGenerated,\n    ['User Name'] = UserName,\n    ['Client Type'] = ClientType,\n    ['Connection Status'] = ConnectionStatus,\n    ['State Details'] = State\n| order by TimeGenerated desc",
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/YOUR_RESOURCE_GROUP/providers/Microsoft.OperationalInsights/workspaces/YOUR_WORKSPACE_NAME"
        ],
        "visualization": "table"
      },
      "name": "user-connection-status"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// End-User Experience - Connection Patterns\nWVDConnections\n| where TimeGenerated > ago(24h)\n| where isnotempty(CorrelationId)\n| summarize\n    ['Connection Count'] = count(),\n    ['Success Count'] = countif(State == \"Connected\"),\n    ['Failure Count'] = countif(State contains \"Failed\" or State contains \"Timeout\")\n    by bin(TimeGenerated, 1h)\n| extend ['Success Rate'] = strcat(round((toreal(['Success Count']) / toreal(['Connection Count'])) * 100, 2), '%')\n| order by TimeGenerated desc",
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/YOUR_RESOURCE_GROUP/providers/Microsoft.OperationalInsights/workspaces/YOUR_WORKSPACE_NAME"
        ],
        "visualization": "table"
      },
      "name": "user-connection-patterns"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// End-User Experience - Client Analysis\nWVDConnections\n| where TimeGenerated > ago(24h)\n| where isnotempty(CorrelationId)\n| summarize\n    TotalAttempts = count(),\n    SuccessfulConnections = countif(State == \"Connected\"),\n    FailedConnections = countif(State contains \"Failed\" or State contains \"Timeout\")\n    by ClientType\n| extend SuccessRate = round((toreal(SuccessfulConnections) / toreal(TotalAttempts)) * 100, 2)\n| extend ClientHealth = iff(SuccessRate >= 90, \"üü¢ Excellent\",\n    iff(SuccessRate >= 70, \"üü° Good\",\n    iff(SuccessRate >= 50, \"üü† Needs Attention\",\n    \"üî¥ Critical\")))\n| project\n    ['Client Type'] = ClientType,\n    ['Health Status'] = ClientHealth,\n    ['Success Rate'] = strcat(SuccessRate, '%'),\n    ['Total Attempts'] = TotalAttempts,\n    ['Successful'] = SuccessfulConnections,\n    ['Failed'] = FailedConnections\n| order by ['Success Rate'] desc",
        "size": 0,
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "/subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/YOUR_RESOURCE_GROUP/providers/Microsoft.OperationalInsights/workspaces/YOUR_WORKSPACE_NAME"
        ],
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Success Rate",
              "formatter": 8,
              "formatOptions": {
                "min": 70,
                "max": 100,
                "palette": "redGreen"
              }
            }
          ]
        }
      },
      "name": "user-client-analysis"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/YOUR_SUBSCRIPTION_ID/resourceGroups/YOUR_RESOURCE_GROUP/providers/Microsoft.OperationalInsights/workspaces/YOUR_WORKSPACE_NAME"
  ],
  "styleSettings": {}
}
